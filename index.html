<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>dualshock</title>
    <link rel="icon" type="image/png" href="assets/dsfavicon.png">

    <style>
        @font-face {
            font-family: 'BrandFont';
            src: url('assets/fonts/dualshock-font.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Neue Haas Grotesk';
            src: url('example-site/fonts/neue-haas-grotesk-regular.woff2') format('woff2'),
                 url('example-site/fonts/neue-haas-grotesk-regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        html {
            background: #000;
            color: #fff;
            font-size: 16px;
            height: 100%;
            overflow: hidden;
            -moz-osx-font-smoothing: grayscale;
            -webkit-font-smoothing: antialiased;
        }
        body {
            font: 1rem 'Neue Haas Grotesk', -apple-system, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        a { color: inherit; text-decoration: none; }
        button { background: none; border: none; color: inherit; font: inherit; cursor: pointer; }

        /* Canvas - Goom visualiser, only when playing */
        #canvas {
            display: block;
            height: 100vh; left: 0; top: 0; width: 100%;
            pointer-events: none; position: fixed;
            z-index: 2; background: #000;
            opacity: 0; transition: opacity 0.4s;
        }
        #canvas.playing { opacity: 1; }

        /* Logo - always visible, centered top, on top of overlays */
        .logo {
            color: #fff;
            font-family: 'BrandFont', sans-serif;
            position: fixed;
            left: 50%; top: 2rem;
            transform: translateX(-50%);
            z-index: 2000;
        }
        .logo a {
            display: block;
            font-size: clamp(2rem, 5vw, 3.5rem);
            transition: opacity 0.2s;
        }
        .logo a:hover { opacity: 0.8; }

        /* Bottom bar - like Peggy: nav OR player, never both */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        /* Player - hidden by default, replaces nav when playing */
        .player {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.25rem 2rem;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }
        .player--active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Nav - visible by default, hides when player active */
        .bottom-bar.player-active .navigation {
            opacity: 0;
            pointer-events: none;
        }
        .bottom-bar.player-active .player {
            opacity: 1;
            pointer-events: auto;
        }
        .player__button {
            flex-shrink: 0;
            width: 1.2rem;
            height: 1.2rem;
            padding: 0;
            transition: opacity 0.4s;
        }
        .player__button:hover { opacity: 0.5; }
        .player__button__icons {
            height: 1.2rem;
            position: relative;
            width: 1.2rem;
        }
        .player__button__play,
        .player__button__pause {
            font-size: 0;
            height: 1.2rem;
            left: 50%;
            position: absolute;
            top: 50%;
            width: 1.2rem;
        }
        .player__button__play {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 22 28'%3E%3Cpath fill='%23fff' d='M0,0v28l22-14L0,0z'/%3E%3C/svg%3E") no-repeat center/contain;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.25);
            transition: opacity 0.4s, transform 0.4s;
        }
        .player__button--paused .player__button__play {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .player__button__pause {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 22 28'%3E%3Crect fill='%23fff' x='0.5' width='7' height='28'/%3E%3Crect fill='%23fff' x='14.5' width='7' height='28'/%3E%3C/svg%3E") no-repeat center/contain;
            transform: translate(-50%, -50%) scale(1);
            transition: opacity 0.4s, transform 0.4s;
        }
        .player__button--paused .player__button__pause {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.25);
        }
        .player__button--playing .player__button__play {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.25);
        }
        .player__button--playing .player__button__pause {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .player__track-select {
            flex-shrink: 0;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.4);
            color: #fff;
            font: inherit;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            min-width: 120px;
        }
        .player__track-select:hover { border-color: rgba(255,255,255,0.7); }
        .player__track-select option { background: #000; color: #fff; }

        .player__progress {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            height: 1.5rem;
            cursor: pointer;
        }
        .player__progress__line {
            width: 100%;
            height: 2px;
            background: hsla(0,0%,100%,0.4);
            position: relative;
        }
        .player__progress__length {
            background: #fff;
            height: 100%;
            left: 0;
            position: absolute;
            top: 0;
            transform: scaleX(0);
            transform-origin: left;
            width: 100%;
        }

        .player__title {
            flex-shrink: 0;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .player__download {
            flex-shrink: 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
        }
        .player__download:hover { opacity: 0.6; }
        .player__download.hidden { display: none; }

        .player__fullscreen {
            flex-shrink: 0;
            width: 1.2rem;
            height: 1.2rem;
            padding: 0;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 14 14'%3E%3Cpath d='M2 9H0v5h5v-2H2V9zM0 5h2V2h3V0H0v5zm12 7H9v2h5V9h-2v3zM9 0v2h3v3h2V0H9z' fill='%23fff' fill-rule='evenodd'/%3E%3C/svg%3E") no-repeat center/contain;
        }
        .player__fullscreen:hover { opacity: 0.5; }

        .player__back {
            flex-shrink: 0;
            font-size: 1rem;
            opacity: 0.7;
            padding: 0.25rem;
        }
        .player__back:hover { opacity: 1; }

        /* Navigation - visible by default, hides when player active */
        .navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.25rem 2rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-size: 0.85rem;
            transition: opacity 0.4s;
        }
        .navigation__list {
            display: flex;
            gap: 2.5rem;
            list-style: none;
        }
        .navigation__link {
            cursor: pointer;
            transition: opacity 0.4s;
        }
        .navigation__link:hover { opacity: 0.5; }

        /* Content overlays */
        .content-section {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 1500;
            align-items: center;
            justify-content: center;
            padding: 5rem 2rem;
        }
        .content-section.active { display: flex; flex-direction: column; }
        .content-inner {
            max-width: 480px;
            text-align: center;
            font-size: 1rem;
            line-height: 1.7;
        }
        .content-inner h2 { font-size: 1.1rem; margin-bottom: 1rem; letter-spacing: 0.1em; }
        .content-section .close-hint { margin-top: 1.5rem; font-size: 0.8rem; opacity: 0.6; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <h1 class="logo">
        <a href="#" onclick="resetToLanding(); return false;">dualshock</a>
    </h1>

    <div class="bottom-bar">
        <div class="player" id="player">
            <button class="player__button player__button--paused" id="play-btn" onclick="togglePlayback()">
                <div class="player__button__icons">
                    <div class="player__button__play">Play</div>
                    <div class="player__button__pause">Pause</div>
                </div>
            </button>

            <select class="player__track-select" id="track-select" onchange="pickTrack(this.value)">
                <option value="">Select track</option>
                <!-- populated dynamically from Supabase -->
            </select>

            <div class="player__progress" onclick="seek(event)">
                <div class="player__progress__line">
                    <div class="player__progress__length" id="progress-fill"></div>
                </div>
            </div>

            <p class="player__title">dualshock <span id="track-name"></span></p>

            <a id="download-btn" class="player__download hidden" href="#" download>Download</a>

            <button class="player__fullscreen" onclick="toggleFullscreen()"></button>
            <button class="player__back" onclick="togglePlayer()" title="Back to menu">✕</button>
        </div>

        <nav class="navigation">
            <ul class="navigation__list">
                <li><a class="navigation__link" onclick="togglePlayer()">Music</a></li>
                <li><a class="navigation__link" onclick="showSection('bookings')">Bookings</a></li>
                <li><a class="navigation__link" onclick="showSection('contact')">Contact</a></li>
            </ul>
        </nav>
    </div>


    <section id="bookings" class="content-section">
        <div class="content-inner">
            <h2>Bookings</h2>
            <p>For bookings and collaborations:</p>
            <p><a href="mailto:bookings@dualshockmusic.com">bookings@dualshockmusic.com</a></p>
            <p class="close-hint">Click dualshock above to return</p>
        </div>
    </section>
    <section id="contact" class="content-section">
        <div class="content-inner">
            <h2>Contact</h2>
            <p>Email: <a href="mailto:contact@dualshockmusic.com">contact@dualshockmusic.com</a></p>
            <p class="close-hint">Click dualshock above to return</p>
        </div>
    </section>

    <!-- Supabase JS client (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script>
        /* ── Supabase config ── */
        const SUPABASE_URL = 'https://zhiwefnvvshvrorbklph.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoaXdlZm52dnNodnJvcmJrbHBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQxMTksImV4cCI6MjA4NjE1MDExOX0.gY4ermeBc6TWFU4yzrty8OQQL4vS_3FfMLRE1du8oL4';
        const STORAGE_BUCKET = 'dualshock_tracks';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function storageUrl(filePath) {
            return SUPABASE_URL + '/storage/v1/object/public/' + STORAGE_BUCKET + '/' + encodeURIComponent(filePath);
        }

        /* ── Track data (loaded from Supabase) ── */
        let TRACKS = [];

        async function loadTracks() {
            const { data, error } = await sb
                .from('tracks')
                .select('*')
                .eq('is_active', true)
                .order('display_order', { ascending: true });

            if (error) {
                console.error('Error loading tracks:', error);
                return;
            }

            TRACKS = (data || []).map(t => ({
                id: t.id,
                url: storageUrl(t.file_path),
                label: t.title,
                filePath: t.file_path
            }));

            populateTrackSelect();
        }

        function populateTrackSelect() {
            const sel = document.getElementById('track-select');
            // Clear existing options (keep the placeholder)
            while (sel.options.length > 1) sel.remove(1);

            TRACKS.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.url;
                opt.textContent = t.label;
                sel.appendChild(opt);
            });
        }

        /* ── Audio engine ── */
        var Module = { canvas: document.getElementById("canvas") };

        var audioContext, sourceNode, isPlaying = false, currentBuffer;
        var startTime = 0, pausedAt = 0, currentTrackUrl = null;

        function updateCanvasVisibility() {
            document.getElementById('canvas').classList.toggle('playing', isPlaying && !!currentBuffer);
        }
        function updateDownloadBtn() {
            const btn = document.getElementById('download-btn');
            if (currentTrackUrl && currentBuffer) {
                btn.href = currentTrackUrl;
                btn.download = decodeURIComponent(currentTrackUrl.split('/').pop()) || 'track.mp3';
                btn.classList.remove('hidden');
            } else btn.classList.add('hidden');
        }

        function togglePlayer() {
            const player = document.getElementById('player');
            const bar = document.querySelector('.bottom-bar');
            player.classList.toggle('player--active');
            bar.classList.toggle('player-active', player.classList.contains('player--active'));
        }

        function pickTrack(url) {
            if (!url) return;
            loadAndPlay(url);
        }

        async function loadAndPlay(url) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.leftAnalyser = audioContext.createAnalyser();
                audioContext.rightAnalyser = audioContext.createAnalyser();
                audioContext.leftAnalyser.fftSize = 512;
                audioContext.rightAnalyser.fftSize = 512;
            }
            if (audioContext.state === 'suspended') await audioContext.resume();
            if (sourceNode) sourceNode.stop();

            document.getElementById('track-name').textContent = ' – loading…';
            document.getElementById('player').classList.add('player--active');
            document.querySelector('.bottom-bar').classList.add('player-active');

            try {
                const res = await fetch(url);
                const buf = await res.arrayBuffer();
                audioContext.decodeAudioData(buf, buffer => {
                    currentBuffer = buffer;
                    currentTrackUrl = url;
                    startBufferSource(0);
                    const track = TRACKS.find(t => t.url === url);
                    const label = track ? track.label : decodeURIComponent(url.split('/').pop()).replace('.mp3','');
                    document.getElementById('track-select').value = url;
                    document.getElementById('track-name').textContent = ' – ' + label;
                    document.getElementById('play-btn').classList.remove('player__button--paused');
                    document.getElementById('play-btn').classList.add('player__button--playing');
                    isPlaying = true;
                    updateCanvasVisibility();
                    updateDownloadBtn();
                });
            } catch (e) {
                console.error(e);
                document.getElementById('track-name').textContent = ' – error';
                document.getElementById('track-select').value = '';
            }
        }

        function startBufferSource(offset) {
            if (sourceNode) sourceNode.stop();
            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = currentBuffer;
            sourceNode.loop = true;
            audioContext.source = sourceNode;

            const splitter = audioContext.createChannelSplitter(2);
            sourceNode.connect(splitter);
            sourceNode.connect(audioContext.destination);
            splitter.connect(audioContext.leftAnalyser, 0, 0);
            if (currentBuffer.numberOfChannels > 1)
                splitter.connect(audioContext.rightAnalyser, 1, 0);
            else
                splitter.connect(audioContext.leftAnalyser, 0, 0);

            startTime = audioContext.currentTime - offset;
            sourceNode.start(0, offset);
            animateProgress();
        }

        function togglePlayback() {
            if (!currentBuffer) return;
            if (isPlaying) {
                sourceNode.stop();
                if (audioContext) audioContext.source = null;
                pausedAt = Math.min(audioContext.currentTime - startTime, currentBuffer.duration);
                document.getElementById('play-btn').classList.add('player__button--paused');
                document.getElementById('play-btn').classList.remove('player__button--playing');
                isPlaying = false;
            } else {
                const offset = Math.min(pausedAt, currentBuffer.duration - 0.01);
                startBufferSource(offset);
                document.getElementById('play-btn').classList.remove('player__button--paused');
                document.getElementById('play-btn').classList.add('player__button--playing');
                isPlaying = true;
            }
            updateCanvasVisibility();
            updateDownloadBtn();
        }

        function animateProgress() {
            if (!isPlaying || !currentBuffer) return;
            const elapsed = audioContext.currentTime - startTime;
            const pct = (elapsed % currentBuffer.duration) / currentBuffer.duration * 100;
            document.getElementById('progress-fill').style.transform = 'scaleX(' + pct/100 + ')';
            requestAnimationFrame(animateProgress);
        }

        function seek(e) {
            if (!currentBuffer) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            pausedAt = pos * currentBuffer.duration;
            if (isPlaying) startBufferSource(pausedAt);
            else document.getElementById('progress-fill').style.transform = 'scaleX(' + pos + ')';
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement)
                document.documentElement.requestFullscreen?.() || document.body.requestFullscreen?.();
            else document.exitFullscreen?.();
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('player').classList.remove('player--active');
            document.querySelector('.bottom-bar').classList.remove('player-active');
        }

        function resetToLanding() {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('player').classList.remove('player--active');
            document.querySelector('.bottom-bar').classList.remove('player-active');
        }

        /* ── Init: load tracks from Supabase on page load ── */
        loadTracks();
    </script>
    <script src="js/goom.js"></script>
</body>
</html>
